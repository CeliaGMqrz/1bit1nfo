<!DOCTYPE html>
<html lang="en" data-theme=""><head>
    <title> Celia García Márquez | Cortafuegos perimetral. Iptables </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.80.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Un bit de información cada día">
    
    <link rel="stylesheet"
          href="https://1bit1nfo.netlify.app/css/style.min.632053cf9f355189adf9c13322ca0fc44922cb5d98277ed289dff13e3aa7f061.css"
          integrity="sha256-YyBTz581UYmt&#43;cEzIsoPxEkiy12YJ37Sid/xPjqn8GE="
          crossorigin="anonymous"
          type="text/css">
    
    <link rel="stylesheet"
        href="https://1bit1nfo.netlify.app/css/markupHighlight.min.4ac4c94828876abc926f5563ef81e319b441b25cad2c96842d2b87fd204a0de6.css"
        integrity="sha256-SsTJSCiHarySb1Vj74HjGbRBslytLJaELSuH/SBKDeY="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="https://1bit1nfo.netlify.app/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://1bit1nfo.netlify.app/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://1bit1nfo.netlify.app/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://1bit1nfo.netlify.app/favicons/favicon-16x16.png">

    <link rel="canonical" href="https://1bit1nfo.netlify.app/post/cortafuegos/">

    
    
    
    
    <script type="text/javascript"
            src="https://1bit1nfo.netlify.app/js/anatole-header.min.d8599ee07b7d3f11bafbac30657ccc591e8d7fd36a9f580cd4c09e24e0e4a971.js"
            integrity="sha256-2Fme4Ht9PxG6&#43;6wwZXzMWR6Nf9Nqn1gM1MCeJODkqXE="
            crossorigin="anonymous"></script>


    
        
        
        <script type="text/javascript"
                src="https://1bit1nfo.netlify.app/js/anatole-theme-switcher.min.e289e9ebb2a4e7a7f895859c8a2b0da2de1ec73f22cea58d8475aa0597023837.js"
                integrity="sha256-4onp67Kk56f4lYWciisNot4exz8izqWNhHWqBZcCODc="
                crossorigin="anonymous"></script>
    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://1bit1nfo.netlify.app/images/avatar_red.jpg"/>

<meta name="twitter:title" content="Cortafuegos perimetral. Iptables"/>
<meta name="twitter:description" content="Introducción Vamos a construir un cortafuegos en dulcinea que nos permita controlar el tráfico de nuestra red."/>


    

</head>
<body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="https://1bit1nfo.netlify.app/images/avatar_red.jpg" alt="profile picture">
            <h3 title=""><a href="/">Un bit de información cada día</a></h3>
            <div class="description">
                <p>Un bit de información cada día</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://www.linkedin.com/in/cgmarquez/" rel="me" aria-label="Linkedin">
                    <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/CeliaGMqrz" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="mailto:cg.marquez95@gmail.com" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Celia García Márquez  2020-2021 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Inicio</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">Sobre mí</a></li>
        
        
        
            <li class="theme-switch-item">
                <a class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post  animated fadeInDown ">
        <div class="post-content">
            
            <div class="post-title">
                <h3>Cortafuegos perimetral. Iptables</h3>
                
                    <div class="info">
                        <em class="fas fa-calendar-day"></em>
                        <span class="date"> Mon, Jan 25, 2021 
                                           </span>
                        <em class="fas fa-stopwatch"></em>
                        <span class="reading-time">15-minute read</span>
                    </div>
                
            </div>

            <h2 id="introducción">Introducción</h2>
<p>Vamos a construir un <strong>cortafuegos</strong> en dulcinea que nos permita controlar el tráfico de nuestra red. El cortafuegos que vamos a construir debe funcionar tras un reinicio.</p>
<p>La política por defecto que vamos a configurar en nuestro cortafuegos será de tipo <strong>DROP</strong>.</p>
<h3 id="nat">NAT</h3>
<h3 id="1las-máquinas-de-nuestra-red-tienen-que-tener-acceso-al-exterior">1.Las máquinas de nuestra red tienen que tener acceso al exterior</h3>
<p>Estas reglas de iptables ya estaban configuradas en ejercicios anteriores, son las siguientes:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">up iptables -t nat -A POSTROUTING -s 10.0.1.0/24 -o eth0 -j MASQUERADE
up iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE
</code></pre></div><p>Pero lo vamos a cambiar de forma que esté configurado con la dirección estática. Estas reglas las modificaremos en el fichero <strong>/etc/network/interfaces</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">up iptables -t nat -A POSTROUTING -s 10.0.1.0/24 -o eth0 -j SNAT --to 10.0.0.3
up iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j SNAT --to 10.0.0.3
</code></pre></div><p>Reiniciamos el servicio y vemos que se ha configurado correctamente. Además podemos ver que tenemos otras reglas ya configuraras para los diferentes servicios que hemos ido configurando a lo largo del curso. Aunque aquí lo único que nos interesan son las lineas de SNAT.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@dulcinea:~$ sudo iptables -t nat -L -nv
Chain PREROUTING <span class="o">(</span>policy ACCEPT <span class="m">352</span> packets, <span class="m">28200</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
    <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.0.2.4:80
    <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 to:10.0.2.4:443
    <span class="m">1</span>    <span class="m">94</span> DNAT       udp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            udp dpt:53 to:10.0.1.2:53
    <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:25 to:10.0.1.2:25

Chain INPUT <span class="o">(</span>policy ACCEPT <span class="m">12</span> packets, <span class="m">2103</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination

Chain POSTROUTING <span class="o">(</span>policy ACCEPT <span class="m">44</span> packets, <span class="m">2953</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
  <span class="m">329</span> <span class="m">24699</span> SNAT       all  --  *      eth0    10.0.1.0/24          0.0.0.0/0            to:10.0.0.3
    <span class="m">5</span>   <span class="m">396</span> SNAT       all  --  *      eth0    10.0.2.0/24          0.0.0.0/0            to:10.0.0.3

Chain OUTPUT <span class="o">(</span>policy ACCEPT <span class="m">39</span> packets, <span class="m">2584</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</code></pre></div><ul>
<li>Comprobamos que tenemos acceso al exterior desde todas las máquinas del escenario</li>
</ul>
<blockquote>
<p>Suponemos que tenemos bien configurado nuestro servidor DNS que es Freston y que en el fichero /etc/resolv.conf de cada máquina estamos apuntando a él (10.0.1.2)</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#Dulcinea</span>

debian@dulcinea:~$ ping www.google.es
PING www.google.es <span class="o">(</span>142.250.184.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">112</span> <span class="nv">time</span><span class="o">=</span><span class="m">231</span> ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">112</span> <span class="nv">time</span><span class="o">=</span><span class="m">306</span> ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">112</span> <span class="nv">time</span><span class="o">=</span><span class="m">198</span> ms
^C
--- www.google.es ping statistics ---
<span class="m">4</span> packets transmitted, <span class="m">3</span> received, 25% packet loss, <span class="nb">time</span> 6ms
rtt min/avg/max/mdev <span class="o">=</span> 198.016/245.154/306.043/45.161 ms


<span class="c1">#Freston</span>
debian@freston:~$ ping www.google.es
PING www.google.es <span class="o">(</span>142.250.184.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>69.7 ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>42.10 ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>67.8 ms
^C
--- www.google.es ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 5ms
rtt min/avg/max/mdev <span class="o">=</span> 42.993/60.184/69.743/12.183 ms


<span class="c1">#Sancho</span>

ubuntu@sancho:~$ ping www.google.es
PING www.google.es <span class="o">(</span>142.250.184.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>55.4 ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>44.5 ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>48.7 ms
^C
--- www.google.es ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2002ms
rtt min/avg/max/mdev <span class="o">=</span> 44.477/49.522/55.356/4.476 ms

<span class="c1">#Quijote</span>
<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ ping www.google.es
PING www.google.es <span class="o">(</span>142.250.184.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>47.6 ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>42.4 ms
<span class="m">64</span> bytes from mad41s10-in-f3.1e100.net <span class="o">(</span>142.250.184.3<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">111</span> <span class="nv">time</span><span class="o">=</span>43.5 ms
^C
--- www.google.es ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 449ms

</code></pre></div><h3 id="2-configura-de-manera-adecuada-todas-las-reglas-nat-necesarias-para-que-los-servicios-expuestos-al-exterior-sean-accesibles">2. Configura de manera adecuada todas las reglas NAT necesarias para que los servicios expuestos al exterior sean accesibles.</h3>
<p>Tenemos dos servicios: Servidor DNS y Servidor Web</p>
<h3 id="servidor-dns-freston">Servidor DNS (FRESTON)</h3>
<p>Para ello necesitaremos tener bien configurado nuestro servidor DNS y las reglas pertintentes en Dulcinea para que funcione correctamente de forma que:</p>
<ul>
<li>Esta regla ya la teniamos agregada previamente.</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo iptables -t nat -A PREROUTING -p udp --dport <span class="m">53</span> -i eth0 -j DNAT --to 10.0.1.2:53
</code></pre></div><ul>
<li>Funciona después de cada reinicio porque hemos instalado un paquete llamado <code>iptables-persistent</code></li>
</ul>
<p>Si editamos el fichero donde tenemos guardadas las reglas:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo nano /etc/iptables/rules.v4
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">. . .
. . .

<span class="c1"># Regla para que se puedan realizar consultas desde fuera nuestro DNS</span>

-A PREROUTING -i eth0 -p udp -m udp --dport <span class="m">53</span> -j DNAT --to-destination 10.0.1.2:53

. . .
. . .

</code></pre></div><ul>
<li>Comprobamos que podemos hacer una consulta desde el exterior y responde correctamente.</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">celiagm@debian:~$ dig @172.22.200.222 ns celia.gonzalonazareno.org

<span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+deb10u3-Debian &lt;&lt;&gt;&gt; @172.22.200.222 ns celia.gonzalonazareno.org
<span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">26194</span>
<span class="p">;;</span> flags: qr aa rd ra<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">2</span>

<span class="p">;;</span> OPT PSEUDOSECTION:
<span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
<span class="p">;</span> COOKIE: e11a461c6588fede6608354360421f03b7895a49c1216c3f <span class="o">(</span>good<span class="o">)</span>
<span class="p">;;</span> QUESTION SECTION:
<span class="p">;</span>celia.gonzalonazareno.org.	IN	NS

<span class="p">;;</span> ANSWER SECTION:
celia.gonzalonazareno.org. <span class="m">86400</span> IN	NS	dulcinea.celia.gonzalonazareno.org.

<span class="p">;;</span> ADDITIONAL SECTION:
dulcinea.celia.gonzalonazareno.org. <span class="m">86400</span> IN A	172.22.200.222

<span class="p">;;</span> Query time: <span class="m">73</span> msec
<span class="p">;;</span> SERVER: 172.22.200.222#53<span class="o">(</span>172.22.200.222<span class="o">)</span>
<span class="p">;;</span> WHEN: vie mar <span class="m">05</span> 13:07:31 CET <span class="m">2021</span>
<span class="p">;;</span> MSG SIZE  rcvd: <span class="m">121</span>

</code></pre></div><h3 id="servidor-web-quijote">Servidor web (Quijote)</h3>
<p>Nuestro servidor web nos ofrece servicio por el puerto 80 y por el puerto 443 (https), ya teniamos nuestras reglas agregadas que son las siguientes, también contempladas en el fichero de /etc/iptables/rules.v4</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># para usar http puerto 80</span>

sudo iptables -t nat -A PREROUTING -p tcp --dport <span class="m">80</span> -i eth0 -j DNAT --to 10.0.2.4:80


<span class="c1"># Para usar https puerto 443</span>

iptables -A OUTPUT -p tcp -m tcp --dport <span class="m">443</span> -j ACCEPT

sudo iptables -t nat -A PREROUTING -p tcp --dport <span class="m">443</span> -i eth0 -j DNAT --to 10.0.2.4:443

</code></pre></div><p>Fucionamiento:</p>
<p>Si entramos en la página web <a href="http://www.celia.gonzalonazareno.org">www.celia.gonzalonazareno.org</a></p>
<p><img src="/images/cortafuegos/bienvenido.png" alt="bienvenido.png"></p>
<p>Podemos ver que se han utilizado las dos reglas que hemos añadido</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@dulcinea:~$ sudo iptables -t nat -L -nv
Chain PREROUTING <span class="o">(</span>policy ACCEPT <span class="m">416</span> packets, <span class="m">34596</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
    <span class="m">5</span>   <span class="m">300</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.0.2.4:80
    <span class="m">5</span>   <span class="m">300</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 to:10.0.2.4:443

. . .
. . .
</code></pre></div><h2 id="reglas">Reglas</h2>
<h2 id="ping">PING</h2>
<ul>
<li>Tenemos que hacer ping desde todas las maquinas</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Desde dulcinea</span>
debian@dulcinea:~$ ping sancho
PING sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.10 ms
<span class="m">64</span> bytes from sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.681 ms
^C
--- sancho.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 3ms
rtt min/avg/max/mdev <span class="o">=</span> 0.681/0.888/1.095/0.207 ms
debian@dulcinea:~$ ping freston
PING freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.435 ms
<span class="m">64</span> bytes from freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.808 ms
^C
--- freston.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 3ms
rtt min/avg/max/mdev <span class="o">=</span> 0.435/0.621/0.808/0.188 ms
debian@dulcinea:~$ ping quijote
PING quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.17 ms
<span class="m">64</span> bytes from quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.966 ms
<span class="m">64</span> bytes from quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.696 ms
^C
--- quijote.celia.gonzalonazareno.org ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 5ms
rtt min/avg/max/mdev <span class="o">=</span> 0.696/0.945/1.173/0.195 ms


<span class="c1"># Desde freston</span>

debian@freston:~$ ping dulcinea.celia.gonzalonazareno.org
PING dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.469 ms
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.642 ms
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.518 ms
^C
--- dulcinea.celia.gonzalonazareno.org ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 53ms
rtt min/avg/max/mdev <span class="o">=</span> 0.469/0.543/0.642/0.072 ms
debian@freston:~$ ping quijote.celia.gonzalonazareno.org
PING quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>1.47 ms
<span class="m">64</span> bytes from quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>1.26 ms
^C
--- quijote.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 3ms
rtt min/avg/max/mdev <span class="o">=</span> 1.261/1.364/1.467/0.103 ms
debian@freston:~$ ping sancho.celia.gonzalonazareno.org
PING sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.18 ms
<span class="m">64</span> bytes from sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.672 ms
<span class="m">64</span> bytes from sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.592 ms
^C
--- sancho.celia.gonzalonazareno.org ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 5ms
rtt min/avg/max/mdev <span class="o">=</span> 0.592/0.816/1.184/0.262 ms


<span class="c1">## Desde quijote</span>

<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ ping freston.celia.gonzalonazareno.org
PING freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>1.18 ms
<span class="m">64</span> bytes from freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>1.09 ms
^C
--- freston.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 3ms
rtt min/avg/max/mdev <span class="o">=</span> 1.086/1.134/1.182/0.048 ms

<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ ping dulcinea.celia.gonzalonazareno.org
PING dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.370 ms
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.773 ms
^C
--- dulcinea.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1ms
rtt min/avg/max/mdev <span class="o">=</span> 0.370/0.571/0.773/0.202 ms

<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ ping sancho.celia.gonzalonazareno.org
PING sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>0.745 ms
<span class="m">64</span> bytes from sancho.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.11<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>1.27 ms
^C
--- sancho.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 2ms
rtt min/avg/max/mdev <span class="o">=</span> 0.745/1.007/1.270/0.264 ms

<span class="c1"># Desde sancho</span>

ubuntu@sancho:~$ ping dulcinea.celia.gonzalonazareno.org
PING dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.611 ms
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.573 ms
<span class="m">64</span> bytes from dulcinea.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.6<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.568 ms
^C
--- dulcinea.celia.gonzalonazareno.org ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2033ms
rtt min/avg/max/mdev <span class="o">=</span> 0.568/0.584/0.611/0.019 ms
ubuntu@sancho:~$ ping quijote.celia.gonzalonazareno.org
PING quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>1.33 ms
<span class="m">64</span> bytes from quijote.celia.gonzalonazareno.org <span class="o">(</span>10.0.2.4<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>1.09 ms
^C
--- quijote.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1001ms
rtt min/avg/max/mdev <span class="o">=</span> 1.088/1.206/1.325/0.118 ms
ubuntu@sancho:~$ ping freston.celia.gonzalonazareno.org
PING freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.429 ms
<span class="m">64</span> bytes from freston.celia.gonzalonazareno.org <span class="o">(</span>10.0.1.2<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.537 ms
^C
--- freston.celia.gonzalonazareno.org ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1001ms
rtt min/avg/max/mdev <span class="o">=</span> 0.429/0.483/0.537/0.054 ms


</code></pre></div><h3 id="1-ssh">1. SSH</h3>
<ul>
<li>1.1. Acceder por ssh a todas las máquinas</li>
</ul>
<h4 id="ssh-dulcinea-a-quijote---sancho---freston">SSH DULCINEA A [QUIJOTE - SANCHO - FRESTON]</h4>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">## SSH desde DULCINEA AL RESTO DE MAQUINAS</span>

debian@dulcinea:~$ ssh freston
Linux freston 4.19.0-13-cloud-amd64 <span class="c1">#1 SMP Debian 4.19.160-2 (2020-11-28) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for</span> each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
You have mail.
Last login: Fri Mar  <span class="m">5</span> 12:46:53 <span class="m">2021</span> from 10.0.1.6
debian@freston:~$ <span class="nb">exit</span>
<span class="nb">logout</span>
Connection to freston closed.
debian@dulcinea:~$ ssh centos@quijote
Last login: Fri Mar  <span class="m">5</span> 13:13:31 <span class="m">2021</span> from 10.0.2.10
<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ <span class="nb">exit</span>
<span class="nb">logout</span>
Connection to quijote closed.
debian@dulcinea:~$ ssh ubuntu@sancho
Welcome to Ubuntu 20.04.1 LTS <span class="o">(</span>GNU/Linux 5.4.0-60-generic x86_64<span class="o">)</span>

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Fri Mar  <span class="m">5</span> 13:46:27 CET <span class="m">2021</span>

  System load:  0.08              Processes:             <span class="m">108</span>
  Usage of /:   37.5% of 9.52GB   Users logged in:       <span class="m">1</span>
  Memory usage: 69%               IPv4 address <span class="k">for</span> ens3: 10.0.1.11
  Swap usage:   0%

 * Introducing self-healing high availability clusters in MicroK8s.
   Simple, hardened, Kubernetes <span class="k">for</span> production, from RaspberryPi to DC.

     https://microk8s.io/high-availability

<span class="m">63</span> updates can be installed immediately.
<span class="m">0</span> of these updates are security updates.
To see these additional updates run: apt list --upgradable


*** System restart required ***
Last login: Fri Mar  <span class="m">5</span> 12:47:25 <span class="m">2021</span> from 10.0.1.6
ubuntu@sancho:~$ <span class="nb">exit</span>
<span class="nb">logout</span>
Connection to sancho closed.
</code></pre></div><h4 id="ssh-red-interna---red-dmz">SSH RED INTERNA - RED DMZ</h4>
<p>Vamos a crear dos reglas iptables del tipo FORWARD para poder acceder desde la red interna a la DMZ y viceversa. Las reglas son las siguientes:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo iptables -A FORWARD -i eth2 -o eth1 -p tcp --sport <span class="m">22</span> -m state --state ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth2 -o eth1 -p tcp --sport <span class="m">22</span> -m state --state ESTABLISHED -j ACCEPT
</code></pre></div><p>Comprobamos que se han añadido las reglas correctamente</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@dulcinea:~$ sudo iptables --list
Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination

Chain FORWARD <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh state ESTABLISHED
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh state ESTABLISHED

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https

</code></pre></div><h5 id="funcionamiento">Funcionamiento</h5>
<p>Comprobamos que podemos entrar por ssh desde freston a quijote y viceversa</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">## Desde freston entramos a quijote y viceversa.</span>

debian@freston:~$ ssh -A centos@quijote.celia.gonzalonazareno.org
Last login: Fri Mar  <span class="m">5</span> 18:29:25 <span class="m">2021</span> from 10.0.1.2

<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ hostname
quijote
<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ ssh debian@freston.celia.gonzalonazareno.org
Linux freston 4.19.0-13-cloud-amd64 <span class="c1">#1 SMP Debian 4.19.160-2 (2020-11-28) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for</span> each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
You have mail.
Last login: Fri Mar  <span class="m">5</span> 18:29:49 <span class="m">2021</span> from 10.0.2.4

debian@freston:~$ hostname
freston

<span class="c1">## Desde quijote entramos a sancho y viceversa</span>

<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ ssh -A ubuntu@sancho.celia.gonzalonazareno.org
Welcome to Ubuntu 20.04.1 LTS <span class="o">(</span>GNU/Linux 5.4.0-60-generic x86_64<span class="o">)</span>

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Fri Mar  <span class="m">5</span> 18:38:53 CET <span class="m">2021</span>

  System load:  0.0               Processes:             <span class="m">107</span>
  Usage of /:   37.5% of 9.52GB   Users logged in:       <span class="m">1</span>
  Memory usage: 63%               IPv4 address <span class="k">for</span> ens3: 10.0.1.11
  Swap usage:   0%

 * Introducing self-healing high availability clusters in MicroK8s.
   Simple, hardened, Kubernetes <span class="k">for</span> production, from RaspberryPi to DC.

     https://microk8s.io/high-availability

<span class="m">63</span> updates can be installed immediately.
<span class="m">0</span> of these updates are security updates.
To see these additional updates run: apt list --upgradable


*** System restart required ***
Last login: Fri Mar  <span class="m">5</span> 18:38:44 <span class="m">2021</span> from 10.0.2.4
ubuntu@sancho:~$ hostname
sancho
ubuntu@sancho:~$ ssh -A centos@quijote.celia.gonzalonazareno.org
The authenticity of host <span class="s1">&#39;quijote.celia.gonzalonazareno.org (10.0.2.4)&#39;</span> can<span class="s1">&#39;t be established.
</span><span class="s1">ECDSA key fingerprint is SHA256:pZTEnytfMqYmtRT/lWIqyDRJAXcbawGuxNeVWCSNQRU.
</span><span class="s1">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span><span class="s1">Warning: Permanently added &#39;</span>quijote.celia.gonzalonazareno.org<span class="err">&#39;</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
Last login: Fri Mar  <span class="m">5</span> 18:38:28 <span class="m">2021</span> from 10.0.2.10
<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ hostname
quijote

</code></pre></div><ul>
<li>1.2. Todas las máquinas pueden hacer ssh a máquinas del exterior</li>
</ul>
<p>Para ello añadimos las siguientes reglas que aceptan las conexiones ssh tanto de entrada como de salida en dulcinea</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo iptables -A OUTPUT -o eth0 -p tcp --dport <span class="m">22</span> -j ACCEPT
sudo iptables -A OUTPUT -o eth0 -p tcp --dport <span class="m">22</span> -j ACCEPT
</code></pre></div><p>Comprobamos que se han añadido</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@dulcinea:~$ sudo iptables -t nat -L -nv
Chain PREROUTING <span class="o">(</span>policy ACCEPT <span class="m">63</span> packets, <span class="m">6533</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
    <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.0.2.4:80
    <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 to:10.0.2.4:443
    <span class="m">0</span>     <span class="m">0</span> DNAT       udp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            udp dpt:53 to:10.0.1.2:53
    <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:25 to:10.0.1.2:25

Chain INPUT <span class="o">(</span>policy ACCEPT <span class="m">6</span> packets, <span class="m">1475</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination

Chain POSTROUTING <span class="o">(</span>policy ACCEPT <span class="m">21</span> packets, <span class="m">1512</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
   <span class="m">52</span>  <span class="m">4103</span> SNAT       all  --  *      eth0    10.0.1.0/24          0.0.0.0/0            to:10.0.0.3
    <span class="m">3</span>   <span class="m">228</span> SNAT       all  --  *      eth0    10.0.2.0/24          0.0.0.0/0            to:10.0.0.3

Chain OUTPUT <span class="o">(</span>policy ACCEPT <span class="m">21</span> packets, <span class="m">1512</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@dulcinea:~$ sudo iptables --list
Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination

Chain FORWARD <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh state ESTABLISHED
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh state ESTABLISHED

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https

</code></pre></div><h2 id="dns">DNS</h2>
<ul>
<li>El único dns que pueden usar los equipos de las dos redes es freston, no pueden utilizar un DNS externo.</li>
<li>Dulcinea puede usar cualquier servidor DNS.</li>
<li>Tenemos que permitir consultas dns desde el exterior a freston, para que, por ejemplo, papion-dns pueda preguntar.</li>
</ul>
<blockquote>
<p>Todas estos requisitos ya están dispuestos en anteriores ejercicios.</p>
</blockquote>
<p>Todas las máquinas en el fichero /etc/resolv.conf utilizan el servidor dns de Freston</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">nameserver 10.0.1.2
search celia.gonzalonazareno.org
</code></pre></div><h2 id="base-de-datos">BASE DE DATOS</h2>
<ul>
<li>
<p>A la base de datos de sancho sólo pueden acceder las máquinas de la DMZ.</p>
<ul>
<li>En sancho:</li>
</ul>
</li>
</ul>
<p>Editamos el fichero</p>
<p><code>nano /etc/mysql/my.cnf</code></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">port</span>            <span class="o">=</span> <span class="m">3306</span>
</code></pre></div><p>Comprobamos que el puerto que esta utilizando en este caso es el puerto 3306.</p>
<p>Ademas en el mismo fichero nos aseguramos que están estas dos lineas:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">...
skip-external-locking
bind-address            <span class="o">=</span> 0.0.0.0
...
</code></pre></div><ul>
<li>En dulcinea:</li>
</ul>
<p>Agregamos las reglas de iptables de forma que bloqueamos las conexiones por el puerto 3306 y solo dejamos pasar a quijote con la ip 10.0.2.4</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo iptables -A INPUT -s 10.0.2.4 -p tcp --dport <span class="m">3306</span> -j ACCEPT
sudo iptables -A OUTPUT -d 10.0.2.4 -p tcp --sport <span class="m">3306</span> -j ACCEPT
iptables -A INPUT -p tcp --dport <span class="m">3306</span> -j DROP
iptables -A OUTPUT -p tcp --dport <span class="m">3306</span> -j DROP
</code></pre></div><ul>
<li>Comprobamos que estan añadidas</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@dulcinea:~$ sudo iptables --list --line-numbers
Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination         
<span class="m">1</span>    DROP       tcp  --  anywhere             anywhere             tcp dpt:mysql
<span class="m">2</span>    ACCEPT     tcp  --  quijote.celia.gonzalonazareno.org  anywhere             tcp dpt:mysql
<span class="m">3</span>    DROP       tcp  --  anywhere             anywhere             tcp dpt:mysql
<span class="m">4</span>    ACCEPT     tcp  --  quijote.celia.gonzalonazareno.org  anywhere             tcp dpt:mysql

Chain FORWARD <span class="o">(</span>policy ACCEPT<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination         
<span class="m">1</span>    ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh state ESTABLISHED
<span class="m">2</span>    ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh state ESTABLISHED

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination         
<span class="m">1</span>    ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https
<span class="m">2</span>    ACCEPT     tcp  --  anywhere             quijote.celia.gonzalonazareno.org  tcp spt:mysql
<span class="m">3</span>    DROP       tcp  --  anywhere             anywhere             tcp dpt:mysql

</code></pre></div><ul>
<li>Comprobamos que podemos acceder desde quijote a la base de datos</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">debian@dulcinea:~$ ssh centos@quijote
Last login: Fri Mar  <span class="m">5</span> 20:35:52 <span class="m">2021</span> from 10.0.2.10
<span class="o">[</span>centos@quijote ~<span class="o">]</span>$ mysql -u celia -p -h bd.celia.gonzalonazareno.org
Enter password: 
Welcome to the MariaDB monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
Your MariaDB connection id is <span class="m">133</span>
Server version: 10.4.17-MariaDB-1:10.4.17+maria~focal-log mariadb.org binary distribution

Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.

MariaDB <span class="o">[(</span>none<span class="o">)]</span>&gt; show databases<span class="p">;</span>
+--------------------+
<span class="p">|</span> Database           <span class="p">|</span>
+--------------------+
<span class="p">|</span> db_quijote         <span class="p">|</span>
<span class="p">|</span> information_schema <span class="p">|</span>
<span class="p">|</span> mezzanine          <span class="p">|</span>
<span class="p">|</span> mysql              <span class="p">|</span>
<span class="p">|</span> performance_schema <span class="p">|</span>
<span class="p">|</span> wagtail            <span class="p">|</span>
+--------------------+
<span class="m">6</span> rows in <span class="nb">set</span> <span class="o">(</span>0.002 sec<span class="o">)</span>

MariaDB <span class="o">[(</span>none<span class="o">)]</span>&gt; 

</code></pre></div><h2 id="web">Web</h2>
<p>Las reglas aplicadas son estas:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># para usar http puerto 80</span>

sudo iptables -t nat -A PREROUTING -p tcp --dport <span class="m">80</span> -i eth0 -j DNAT --to 10.0.2.4:80


<span class="c1"># Para usar https puerto 443</span>

iptables -A OUTPUT -p tcp -m tcp --dport <span class="m">443</span> -j ACCEPT

sudo iptables -t nat -A PREROUTING -p tcp --dport <span class="m">443</span> -i eth0 -j DNAT --to 10.0.2.4:443
</code></pre></div><h2 id="servicio-de-correos">Servicio de correos</h2>
<p>Para el correo tenemos aplicada la siguiente regla</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo iptables -t nat -A PREROUTING -p tcp --dport <span class="m">25</span> -i eth0 -j DNAT --to 10.0.1.2:25
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="m">4</span>        <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0            tcp dpt:25 to:10.0.1.2:25
</code></pre></div></div>
        <div class="post-footer">
            <div class="info">
                
                <span class="separator"><a class="tag" href="/tags/cortafuegos/">cortafuegos</a><a class="tag" href="/tags/iptables/">iptables</a></span>

            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://1bit1nfo.netlify.app/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script></body>

</html>
